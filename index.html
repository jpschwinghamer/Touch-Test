<!DOCTYPE html>
<html lang="en-US">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link href="css/style.css" media="screen, projection" rel="stylesheet" type="text/css">
</head>
<body>
  <figure class="box">
    <i class="side front"></i>
    <i class="side back"></i>
  </figure>

  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
  <script type="text/javascript">
    $(document).ready(function(){

      $('.box').each(function(){

        //////// Data
        var   $box = $(this),
              $side = $('.side', $box),
              $front = $('.front', $box),
              $back = $('.back', $box),
              startX,
              startY,
              currentX,
              currentY,
              deltaX,
              deltaY,
              angle,
              direction,
              rotateY = 0,
              rotateX = 0;

        //////// Events

        // Disable page touch events
        $('body').live('touchstart', function(event){
          event.preventDefault();
        })

        // Touch start
        $box.live('touchstart', function(event){
          event.preventDefault();
          startX = event.originalEvent.touches[0].pageX;
          startY = event.originalEvent.touches[0].pageY;
          $box.removeClass('animating');
        });

        // Touch move
        $box.live('touchmove', function(event){
          event.preventDefault();
          currentX = event.originalEvent.touches[0].pageX;
          currentY = event.originalEvent.touches[0].pageY;
          calculateDeltas();
          updatePosition();
        });

        // Touch end
        $box.live('touchend', function(event){
          event.preventDefault();
          $side.addClass('animating');
          calculateAngle();
        });

        // Transition end
        $side.live('webkitTransitionEnd', function(event){
          $(this).removeClass('animating')
        })

        //////// Utility Functions

        // Calculate deltas
        function calculateDeltas(){
          deltaX = startX - currentX;
          deltaY = startY - currentY;
        }

        // Calculate angle
        function calculateAngle(){
          angle = Math.round(Math.atan2(deltaY,deltaX) * 180/Math.PI); // Magic math!
          angle < 0 ? angle = 360 - Math.abs(angle) : angle;
          detectDirection();
        }

        // Realtime position change
        function updatePosition(){
          $front.css({'-webkit-transform' : 'translateZ(0) rotateY(' + (rotateY - (deltaX/2)) + 'deg)'});
          $back.css({'-webkit-transform' : 'translateZ(0) rotateY(' + (rotateY - (deltaX/2) - 180) + 'deg)'});
        }

        // Detect direction
        function detectDirection(){
          if((angle >= 0 && angle <= 90) || (angle <= 360 && angle >= 315)) {
            $front.css({'-webkit-transform': 'translateZ(0) rotateY(' + (rotateY-=180) + 'deg)'});
            $back.css({'-webkit-transform': 'translateZ(0) rotateY(' + (rotateY-180) + 'deg)'});
          }

          if(angle >= 91 && angle <= 314) {
            // $front.css({'-webkit-transform': 'rotateY(' + (rotateY+=180) + 'deg)'})
            $front.css({'-webkit-transform': 'translateZ(0) rotateY(' + (rotateY+=180) + 'deg)'});
            $back.css({'-webkit-transform': 'translateZ(0) rotateY(' + (rotateY-180) + 'deg)'});
          }

          // If you want vertical flipping too, do stuff here
          // if(angle >= 46 && angle <= 134) {
          //   console.log('up');
          // }
          //
          // if(angle >= 226 && angle <= 314) {
          //   console.log('down');
          // }
        }


      })




    })
  </script>

</body>
</html>